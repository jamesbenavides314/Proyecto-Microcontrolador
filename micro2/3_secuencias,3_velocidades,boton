#include <xc.h>


#pragma config FOSC = INTOSCIO_EC   
#pragma config WDT = OFF            
#pragma config LVP = OFF           
#pragma config PBADEN = OFF       
#pragma config PLLDIV = 1           
#pragma config CPUDIV = OSC1_PLL2  
#pragma config USBDIV = 2          
#pragma config FCMEN = OFF          
#pragma config IESO = OFF           
#pragma config MCLRE = OFF         

#define _XTAL_FREQ 8000000

// Variables globales
volatile unsigned char secuencia = 0;       // 0, 1, 2 (3 secuencias)
volatile unsigned char velocidad = 0;       // 0, 1, 2 (3 velocidades)
volatile unsigned char paso = 0;            // Paso actual de la secuencia

// Banderas para control de interrupciones
volatile unsigned char cambio_secuencia = 0;
volatile unsigned char cambio_velocidad = 0;

// Delays para las tres velocidades (en milisegundos)
const unsigned int delays[3] = {500, 250, 100};  // Lenta, Media, Rápida

// Función de retardo simple
void delay_ms(unsigned int ms) {
    while(ms--) {
        __delay_ms(1);
    }
}

// Rutina de servicio de interrupción - SOLO levanta banderas
void __interrupt() ISR(void) {
    // Interrupción INT0 - Cambio de secuencia
    if (INTCONbits.INT0IF) {
        if (cambio_secuencia == 0) {    // Solo si no hay una bandera pendiente
            cambio_secuencia = 1;       // Levantar bandera
        }
        INTCONbits.INT0IF = 0;          // Limpiar bandera de interrupción
    }
    
    // Interrupción INT1 - Cambio de velocidad
    if (INTCON3bits.INT1IF) {
        if (cambio_velocidad == 0) {    // Solo si no hay una bandera pendiente
            cambio_velocidad = 1;       // Levantar bandera
        }
        INTCON3bits.INT1IF = 0;         // Limpiar bandera de interrupción
    }
}

// Función para ejecutar la secuencia 1: Encendido secuencial
void secuencia_1(void) {
    if (paso == 0) {
        LATD = 0b00000001;  // Solo D0
    }
    else if (paso == 1) {
        LATD = 0b00000010;  // Solo D1
    }
    else if (paso == 2) {
        LATD = 0b00000100;  // Solo D2
    }
    else if (paso == 3) {
        LATD = 0b00001000;  // Solo D3
    }
    else if (paso == 4) {
        LATD = 0b00000000;  // Todos apagados
    }
    
    paso++;
    if (paso > 4) {
        paso = 0;
    }
}

// Función para ejecutar la secuencia 2: Ida y vuelta
void secuencia_2(void) {
    if (paso == 0) {
        LATD = 0b00000001;  // D0
    }
    else if (paso == 1) {
        LATD = 0b00000010;  // D1
    }
    else if (paso == 2) {
        LATD = 0b00000100;  // D2
    }
    else if (paso == 3) {
        LATD = 0b00001000;  // D3
    }
    else if (paso == 4) {
        LATD = 0b00000100;  // D2 (regreso)
    }
    else if (paso == 5) {
        LATD = 0b00000010;  // D1 (regreso)
    }
    
    paso++;
    if (paso > 5) {
        paso = 0;
    }
}
