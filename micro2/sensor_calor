////////adc.h////////
#ifndef ADC_H
#define ADC_H

void ADC_Init(void);
unsigned int ADC_Read(unsigned char canal);

#endif

////////config.h////////
#ifndef CONFIG_H
#define CONFIG_H

#include <xc.h>
#include <pic18f4550.h>

// Configuración de bits
#pragma config FOSC = INTOSCIO_EC
#pragma config WDT = OFF
#pragma config LVP = OFF
#pragma config PBADEN = OFF
#pragma config MCLRE = OFF

#define _XTAL_FREQ 8000000

#endif

////////HW-498////////
#ifndef HW498_H
#define HW498_H

#define HW498_CANAL 0

void HW498_Init(void);
float HW498_LeerTemperatura(void);

#endif

////////lcd.h////////
#ifndef LCD_H
#define LCD_H

// Definición de pines del LCD
#define LCD_RS PORTBbits.RB0
#define LCD_EN PORTBbits.RB1
#define LCD_D4 PORTBbits.RB4
#define LCD_D5 PORTBbits.RB5
#define LCD_D6 PORTBbits.RB6
#define LCD_D7 PORTBbits.RB7

#define LCD_CLEAR 0x01
#define LCD_HOME 0x02
#define LCD_LINE1 0x80
#define LCD_LINE2 0xC0

void LCD_Init(void);
void LCD_Command(unsigned char cmd);
void LCD_Char(unsigned char data);
void LCD_String(const char *str);
void LCD_Clear(void);
void LCD_SetCursor(unsigned char row, unsigned char col);
void LCD_Float(float num, unsigned char decimales);

#endif

////////adc.c////////
#include "config.h"  // Descomenta si usas archivos separados
#include "adc.h"

void ADC_Init(void) {
    ADCON1bits.PCFG = 0b1110;
    ADCON1bits.VCFG0 = 0;
    ADCON1bits.VCFG1 = 0;
    
    ADCON2bits.ACQT = 0b010;
    ADCON2bits.ADCS = 0b001;
    ADCON2bits.ADFM = 1;
    
    ADCON0bits.ADON = 1;
    __delay_us(50);
}

unsigned int ADC_Read(unsigned char canal) {
    unsigned int resultado;
    
    ADCON0bits.CHS = canal;
    __delay_us(20);
    
    ADCON0bits.GO_DONE = 1;
    while(ADCON0bits.GO_DONE);
    
    resultado = ((unsigned int)ADRESH << 8) | ADRESL;
    return resultado;
}

////////HW-498.c////////
#include "config.h"  // Descomenta si usas archivos separados
#include "adc.h"

void ADC_Init(void) {
    ADCON1bits.PCFG = 0b1110;
    ADCON1bits.VCFG0 = 0;
    ADCON1bits.VCFG1 = 0;
    
    ADCON2bits.ACQT = 0b010;
    ADCON2bits.ADCS = 0b001;
    ADCON2bits.ADFM = 1;
    
    ADCON0bits.ADON = 1;
    __delay_us(50);
}

unsigned int ADC_Read(unsigned char canal) {
    unsigned int resultado;
    
    ADCON0bits.CHS = canal;
    __delay_us(20);
    
    ADCON0bits.GO_DONE = 1;
    while(ADCON0bits.GO_DONE);
    
    resultado = ((unsigned int)ADRESH << 8) | ADRESL;
    return resultado;
}

////////lcd.c////////
#include "config.h"  // Descomenta si usas archivos separados
#include "lcd.h"
#include <stdio.h>

void LCD_Pulse(void) {
    LCD_EN = 1;
    __delay_us(1);
    LCD_EN = 0;
    __delay_us(100);
}

void LCD_SendNibble(unsigned char nibble) {
    LCD_D4 = (nibble >> 0) & 0x01;
    LCD_D5 = (nibble >> 1) & 0x01;
    LCD_D6 = (nibble >> 2) & 0x01;
    LCD_D7 = (nibble >> 3) & 0x01;
    LCD_Pulse();
}

void LCD_Init(void) {
    TRISBbits.TRISB0 = 0;
    TRISBbits.TRISB1 = 0;
    TRISBbits.TRISB4 = 0;
    TRISBbits.TRISB5 = 0;
    TRISBbits.TRISB6 = 0;
    TRISBbits.TRISB7 = 0;
    
    __delay_ms(50);
    LCD_RS = 0;
    
    LCD_SendNibble(0x03);
    __delay_ms(5);
    LCD_SendNibble(0x03);
    __delay_us(150);
    LCD_SendNibble(0x03);
    LCD_SendNibble(0x02);
    
    LCD_Command(0x28);
    LCD_Command(0x0C);
    LCD_Command(0x06);
    LCD_Clear();
}

void LCD_Command(unsigned char cmd) {
    LCD_RS = 0;
    LCD_SendNibble(cmd >> 4);
    LCD_SendNibble(cmd & 0x0F);
    __delay_ms(2);
}

void LCD_Char(unsigned char data) {
    LCD_RS = 1;
    LCD_SendNibble(data >> 4);
    LCD_SendNibble(data & 0x0F);
    __delay_ms(1);
}

void LCD_String(const char *str) {
    while(*str) {
        LCD_Char(*str++);
    }
}

void LCD_Clear(void) {
    LCD_Command(LCD_CLEAR);
    __delay_ms(2);
}

void LCD_SetCursor(unsigned char row, unsigned char col) {
    unsigned char position;
    if(row == 1) {
        position = LCD_LINE1 + col;
    } else {
        position = LCD_LINE2 + col;
    }
    LCD_Command(position);
}

void LCD_Float(float num, unsigned char decimales) {
    char buffer[16];
    sprintf(buffer, "%.*f", decimales, num);
    LCD_String(buffer);
}

////////main.c////////
#include "config.h"
#include "adc.h"
#include "lcd.h"
#include "hw498.h"

void Config_Oscilador(void) {
    OSCCONbits.IRCF = 0b111;
    OSCCONbits.SCS = 0b10;
    while(!OSCCONbits.IOFS);
}

void main(void) {
    float temperatura;
    
    Config_Oscilador();
    ADC_Init();
    LCD_Init();
    HW498_Init();
    
    LCD_SetCursor(1, 0);
    LCD_String("Sensor HW-498");
    LCD_SetCursor(2, 0);
    LCD_String("Iniciando...");
    __delay_ms(2000);
    LCD_Clear();
    
    while(1) {
        temperatura = HW498_LeerTemperatura();
        
        LCD_SetCursor(1, 0);
        LCD_String("Temperatura:");
        LCD_SetCursor(2, 0);
        LCD_Float(temperatura, 1);
        LCD_String(" C  ");
        
        __delay_ms(500);
    }
}
